/*!
 * Sheetrock v1.0.0
 * Quickly connect to, query, and lazy-load data from Google Sheets.
 * http://chriszarate.github.io/sheetrock/
 * License: MIT
 */
(function(e,r,t){"use strict";if(typeof define==="function"&&define.amd){define("sheetrock",function(){return t(null,r)})}else if(typeof module==="object"&&module.exports){module.exports=t(require("request"),global||r)}else{r[e]=t(null,r)}})("sheetrock",this,function(e,r){"use strict";var t={2014:{apiEndpoint:"https://docs.google.com/spreadsheets/d/%key%/gviz/tq?",keyFormat:new RegExp("spreadsheets/d/([^/#]+)","i"),gidFormat:new RegExp("gid=([^/&#]+)","i")},2010:{apiEndpoint:"https://spreadsheets.google.com/tq?key=%key%&",keyFormat:new RegExp("key=([^&#]+)","i"),gidFormat:new RegExp("gid=([^/&#]+)","i")}};var a={loaded:{},failed:{},labels:{},header:{},offset:{}};var n=0;var o=r.document;var i=typeof e!=="function";var s=r.jQuery&&r.jQuery.fn&&r.jQuery.fn.jquery;var f=false;if(!Array.prototype.forEach){Array.prototype.forEach=function(e){var r;var t=this;var a=t.length;for(r=0;r<a;r=r+1){e(t[r],r)}}}if(!Array.prototype.map){Array.prototype.map=function(e){var r=this;var t=[];r.forEach(function(r,a){t[a]=e(r,a)});return t}}if(!Object.keys){Object.keys=function(e){var r;var t=[];for(r in e){if(e.hasOwnProperty(r)){t.push(r)}}return t}}var u=function(e,r,t){if(!(e instanceof Error)){e=new Error(e)}if(r&&r.request&&r.request.index){a.failed[r.request.index]=true}if(r&&r.user&&r.user.callback){r.user.callback(e,r,t||null)}else{throw e}};var l=function(e){return e.toString().replace(/^ +/,"").replace(/ +$/,"")};var c=function(e){return Math.max(0,parseInt(e,10)||0)};var v=function(e,r){var t=" "+e.className+" ";return t.indexOf(" "+r+" ")!==-1};var d=function(e){e=e||{};if(e.jquery&&e.length){e=e[0]}return e.nodeType&&e.nodeType===1?e:false};var p=function(){if(o&&i){var e=o.createElement("script");f=e.addEventListener&&e.removeEventListener}return{dom:!!o,jquery:s?s:false,callbackOn404:i==="request"||f,transport:i?"jsonp":"request"}};var h=function(e){var r={};var a=Object.keys(t);a.forEach(function(a){var n=t[a];if(n.keyFormat.test(e)&&n.gidFormat.test(e)){r.key=e.match(n.keyFormat)[1];r.gid=e.match(n.gidFormat)[1];r.apiEndpoint=n.apiEndpoint.replace("%key%",r.key)}});return r};var y=function(e){return e.key&&e.gid?e.key+"_"+e.gid+"_"+e.query:null};var m=function(e){var r=e&&e.v?e.v:"";if(r instanceof Array){r=e.f||r.join("")}return l(r)};var b=function(e,r,t){var a={cells:{},cellsArray:r,labels:t,num:e};r.forEach(function(e,r){a.cells[t[r]]=e});return a};var g=function(e,r){return"<"+r+">"+e+"</"+r+">"};var q=function(e){var r=e.num?"td":"th";var t=Object.keys(e.cells);var a="";t.forEach(function(t){a+=g(e.cells[t],r)});return g(a,"tr")};var k=function(e){a.loaded[e]=false;a.failed[e]=false;a.labels[e]=false;a.header[e]=0;a.offset[e]=0};var E=function(e,r){var t={};var a=Object.keys(e);r.query=r.sql||r.query;r.reset=r.resetStatus||r.reset;r.fetchSize=r.chunkSize||r.fetchSize;r.rowTemplate=r.rowHandler||r.rowTemplate;a.forEach(function(a){t[a]=r[a]||e[a]});return t};var w=function(e,r){r.target=d(r.target)||d(e);r.fetchSize=c(r.fetchSize);return r};var x=function(e,r){var t=w(e,r);var n=h(t.url);n.query=t.query;n.index=y(n);if(t.reset&&n.index){k(n.index);n.reset=true}t.offset=a.offset[n.index]||0;if(t.fetchSize&&n.index){n.query+=" limit "+(t.fetchSize+1);n.query+=" offset "+t.offset;a.offset[n.index]=t.offset+t.fetchSize}return{user:t,request:n}};var j=function(e){if(!e.user.target&&!e.user.callback){throw"No element targeted or callback provided."}if(!(e.request.key&&e.request.gid)){throw"No key/gid in the provided URL."}if(a.failed[e.request.index]){throw"A previous request for this resource failed."}if(a.loaded[e.request.index]){throw"No more rows to load!"}return e};var O=function(e,r){return e&&e.length===r.length?e:r};var N=function(e,r){var t=e.request.index;var n=a.labels[t];var o=e.user.fetchSize;var i=r.table.rows;var s=r.table.cols;var f={last:i.length-1,rowNumberOffset:a.header[t]||0};if(!e.user.offset){n=s.map(function(e,r){if(e.label){return e.label.replace(/\s/g,"")}else{f.last=f.last+1;f.rowNumberOffset=1;return m(i[0].c[r]).replace(/\s/g,"")||e.id}});a.offset[t]=a.offset[t]+f.rowNumberOffset;a.header[t]=f.rowNumberOffset;a.labels[t]=n}if(!o||i.length-f.rowNumberOffset<o){f.last=f.last+1;a.loaded[t]=true}f.labels=O(e.user.labels,n);return f};var S=function(e,r,t){var a=[];var n=r.labels;if(!e.offset&&!r.rowNumberOffset){a.push(b(0,n,n))}t.table.rows.forEach(function(t,o){if(t.c&&o<r.last){var i=c(e.offset+o+1-r.rowNumberOffset);a.push(b(i,t.c.map(m),n))}});return a};var A=function(e,r,t){if(e.tagName==="TABLE"){var a=o.createElement("thead");var n=o.createElement("tbody");a.innerHTML=r;n.innerHTML=t;e.appendChild(a);e.appendChild(n)}else{e.insertAdjacentHTML("beforeEnd",r+t)}};var L=function(e,r){var t=e.rowTemplate||q;var a=o&&o.createElement&&e.target;var n=a&&e.target.tagName==="TABLE";var i=a&&v(e.target,"sheetrock-header");var s="";var f="";r.forEach(function(e){if(e.num){f+=t(e)}else if(n||i){s+=t(e)}});if(a){A(e.target,s,f)}return n?g(s,"thead")+g(f,"tbody"):s+f};var T=function(e,r){var t={raw:r};try{var a=t.attributes=N(e,r);var n=t.rows=S(e.user,a,r);t.html=L(e.user,n);if(e.user.callback){e.user.callback(null,e,t)}}catch(o){u("Unexpected API response format.",e,t)}};var z=function(r,t){var a={headers:{"X-DataSource-Auth":"true"},url:r.request.url};var n=function(e,a,n){if(!e&&a.statusCode===200){try{n=JSON.parse(n.replace(/^\)\]\}\'\n/,""));t(r,n)}catch(o){u(o,r,{raw:n})}}else{u(e||"Request failed.",r)}};e(a,n)};var R=function(e,t){var a=o.getElementsByTagName("head")[0];var i=o.createElement("script");var s="_sheetrock_callback_"+n;var l=function(){if(f){i.removeEventListener("error",v,false);i.removeEventListener("abort",v,false)}a.removeChild(i);delete r[s]};var c=function(r){try{t(e,r)}catch(a){u(a,e,{raw:r})}finally{l()}};var v=function(){u("Request failed.",e);l()};r[s]=c;e.request.url=e.request.url.replace("%callback%",s);if(f){i.addEventListener("error",v,false);i.addEventListener("abort",v,false)}i.type="text/javascript";i.src=e.request.url;a.appendChild(i);n=n+1};var F=function(e){var r=["gid="+encodeURIComponent(e.request.gid),"tq="+encodeURIComponent(e.request.query)];if(i){r.push("tqx=responseHandler:%callback%")}return e.request.apiEndpoint+r.join("&")};var C=function(e,r){e.request.url=F(e);if(i){R(e,r)}else{z(e,r)}};var H={url:"",query:"",target:null,fetchSize:0,labels:[],rowTemplate:null,callback:null,reset:false};var _=function(e,r){try{e=E(H,e||{});e=x(this,e);e=j(e);if(r){T(e,r)}else{C(e,T)}}catch(t){u(t,e)}return this};_.defaults=H;_.version="1.0.0";_.environment=p();if(s){r.jQuery.fn.sheetrock=_}return _});
//# sourceMappingURL=sheetrock.min.js.map